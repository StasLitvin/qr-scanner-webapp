<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>QR Scanner</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #1a1a2e;
      color: #ffffff;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .header { padding: 16px; text-align: center; width: 100%; background: #16213e; }
    .header h1 { font-size: 18px; font-weight: 600; }
    .header p { font-size: 13px; color: #a0a0b0; margin-top: 4px; }

    .scanner-container {
      position: relative;
      width: 100%;
      max-width: 400px;
      margin: 12px auto;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 0 12px;
    }

    .video-wrapper {
      position: relative;
      width: 100%;
      border-radius: 12px;
      overflow: hidden;
      border: 2px solid #0f3460;
      background: #000;
    }

    #video {
      width: 100%;
      display: block;
      object-fit: cover;
    }

    .scan-region {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 200px;
      height: 200px;
      pointer-events: none;
    }

    .scan-region .corner {
      position: absolute;
      width: 30px;
      height: 30px;
      border-color: #e94560;
      border-style: solid;
      border-width: 0;
    }

    .corner.tl { top: 0; left: 0; border-top-width: 4px; border-left-width: 4px; border-radius: 8px 0 0 0; }
    .corner.tr { top: 0; right: 0; border-top-width: 4px; border-right-width: 4px; border-radius: 0 8px 0 0; }
    .corner.bl { bottom: 0; left: 0; border-bottom-width: 4px; border-left-width: 4px; border-radius: 0 0 0 8px; }
    .corner.br { bottom: 0; right: 0; border-bottom-width: 4px; border-right-width: 4px; border-radius: 0 0 8px 0; }

    .scan-line {
      position: absolute;
      left: 10%;
      width: 80%;
      height: 2px;
      background: #e94560;
      animation: scanAnimation 2s linear infinite;
    }

    @keyframes scanAnimation {
      0% { top: 10%; }
      50% { top: 90%; }
      100% { top: 10%; }
    }

    #canvas { display: none; }

    .status {
      margin-top: 12px;
      padding: 12px 20px;
      background: #16213e;
      border-radius: 8px;
      font-size: 14px;
      text-align: center;
      width: 100%;
    }
    .status.success { background: #1b5e20; }
    .status.error { background: #b71c1c; }
    .status.warning { background: #e65100; }

    .btn-row { display: flex; gap: 8px; margin-top: 12px; width: 100%; flex-wrap: wrap; }

    .btn {
      flex: 1 1 calc(50% - 8px);
      padding: 12px 16px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
      color: #fff;
      transition: background 0.2s;
    }

    .btn-switch { background: #0f3460; }
    .btn-switch:active { background: #1a5276; }
    .btn-lens { background: #0b6b53; }
    .btn-lens:active { background: #0f8a6a; }
    .btn-flash { background: #533483; }
    .btn-flash:active { background: #6c44a2; }
    .btn-flash.on { background: #f0a500; color: #1a1a2e; }
    .btn-close { background: #b71c1c; }
    .btn-close:active { background: #d32f2f; }

    .debug {
      margin-top: 8px;
      padding: 8px 12px;
      background: #0d0d1a;
      border-radius: 6px;
      font-size: 11px;
      color: #666;
      width: 100%;
      max-height: 140px;
      overflow-y: auto;
      word-break: break-all;
    }
  </style>
</head>
<body>

<div class="header">
  <h1>–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ QR-–∫–æ–¥–∞</h1>
  <p>–ù–∞–≤–µ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ QR-–∫–æ–¥ —É—á–∞—Å—Ç–Ω–∏–∫–∞</p>
</div>

<div class="scanner-container">
  <div class="video-wrapper">
    <video id="video" autoplay playsinline muted></video>
    <div class="scan-region">
      <div class="corner tl"></div>
      <div class="corner tr"></div>
      <div class="corner bl"></div>
      <div class="corner br"></div>
      <div class="scan-line"></div>
    </div>
  </div>

  <canvas id="canvas"></canvas>

  <div class="status" id="status">–ó–∞–ø—É—Å–∫ –∫–∞–º–µ—Ä—ã...</div>

  <div class="btn-row">
    <button class="btn btn-switch" id="switchBtn">üì∑ –ö–∞–º–µ—Ä–∞</button>
    <button class="btn btn-lens" id="lensBtn">üîÅ –õ–∏–Ω–∑–∞</button>
    <button class="btn btn-flash" id="flashBtn">üî¶ –í—Å–ø—ã—à–∫–∞</button>
    <button class="btn btn-close" id="closeBtn">‚úï –ó–∞–∫—Ä—ã—Ç—å</button>
  </div>

  <div class="debug" id="debug">–õ–æ–≥: –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>

<script>
  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d', { willReadFrequently: true });
  const statusEl = document.getElementById('status');
  const debugEl = document.getElementById('debug');
  const switchBtn = document.getElementById('switchBtn');
  const lensBtn = document.getElementById('lensBtn');
  const flashBtn = document.getElementById('flashBtn');
  const closeBtn = document.getElementById('closeBtn');

  let currentStream = null;
  let currentTrack = null;

  let useFrontCamera = false;
  let flashOn = false;
  let scanActive = true;
  let animFrameId = null;

  let debugLines = [];

  const SCAN_CENTER_FRACTION = 0.6;

  // –°–ø–∏—Å–∫–∏ –∫–∞–º–µ—Ä
  let backCams = [];   // [{deviceId,label}]
  let frontCams = [];  // [{deviceId,label}]
  let backIndex = 0;
  let frontIndex = 0;

  const urlParams = new URLSearchParams(window.location.search);
  const eventId = urlParams.get('event_id') || '0';

  let tg = null;
  let isTelegram = false;
  try {
    if (window.Telegram && window.Telegram.WebApp) {
      tg = window.Telegram.WebApp;
      tg.expand(); tg.ready();
      isTelegram = true;
      log('Telegram WebApp –æ–±–Ω–∞—Ä—É–∂–µ–Ω');
    } else {
      log('–ê–≤—Ç–æ–Ω–æ–º–Ω—ã–π —Ä–µ–∂–∏–º');
    }
  } catch (e) {
    log('TG –æ—à–∏–±–∫–∞: ' + e.message);
  }

  log('event_id = ' + eventId);

  function log(msg) {
    const time = new Date().toLocaleTimeString();
    const line = time + ' | ' + msg;
    debugLines.push(line);
    if (debugLines.length > 18) debugLines.shift();
    debugEl.textContent = debugLines.join('\n');
    debugEl.scrollTop = debugEl.scrollHeight;
    console.log('[QR]', msg);
  }

  function setStatus(text, cls) {
    statusEl.textContent = text;
    statusEl.className = 'status' + (cls ? ' ' + cls : '');
  }

  function waitLoadedMetadata(v) {
    return new Promise((resolve, reject) => {
      const ok = () => { cleanup(); resolve(); };
      const err = () => { cleanup(); reject(new Error('video metadata error')); };
      const cleanup = () => {
        v.removeEventListener('loadedmetadata', ok);
        v.removeEventListener('error', err);
      };
      v.addEventListener('loadedmetadata', ok, { once: true });
      v.addEventListener('error', err, { once: true });
    });
  }

  // ---- –ö–∞–º–µ—Ä–∞: –ø–æ—Å—Ç—Ä–æ–∏—Ç—å —Å–ø–∏—Å–æ–∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è
  async function refreshDeviceLists() {
    if (!navigator.mediaDevices?.enumerateDevices) return;

    const devices = await navigator.mediaDevices.enumerateDevices();
    const vids = devices.filter(d => d.kind === 'videoinput');

    // –≠–≤—Ä–∏—Å—Ç–∏–∫–∞ –ø–æ label (—Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –≤—ã–¥–∞—á–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è)
    const isBack = (label) => /back|rear|environment/i.test(label);
    const isFront = (label) => /front|user|selfie/i.test(label);
    const isBadAux = (label) => /macro|depth|tof|aux/i.test(label);

    const scored = vids.map(d => {
      const label = (d.label || '').trim();
      let scoreBack = 0, scoreFront = 0, penalty = 0;

      if (isBack(label)) scoreBack += 10;
      if (isFront(label)) scoreFront += 10;

      // —á–∞—Å—Ç–æ ‚Äúmacro/depth‚Äù –¥–∞—ë—Ç –º—ã–ª–æ/–Ω–µ —Ç–æ—Ç —Ñ–æ–∫—É—Å
      if (isBadAux(label)) penalty += 8;

      // ‚Äúwide/ultra wide‚Äù ‚Äî –º–æ–∂–µ—Ç –±—ã—Ç—å –æ–∫, –Ω–æ –¥–ª—è QR –∏–Ω–æ–≥–¥–∞ —Ö—É–∂–µ, –ø–æ—ç—Ç–æ–º—É –Ω–µ–±–æ–ª—å—à–æ–π —à—Ç—Ä–∞—Ñ
      if (/ultra|wide/i.test(label)) penalty += 2;

      return { deviceId: d.deviceId, label, scoreBack, scoreFront, penalty };
    });

    backCams = scored
      .sort((a,b) => (b.scoreBack - b.penalty) - (a.scoreBack - a.penalty))
      .filter(x => x.scoreBack > 0 || (!x.label && x.deviceId)); // –µ—Å–ª–∏ label –ø—É—Å—Ç–æ–π, –ø—Ä–æ—Å—Ç–æ –æ—Å—Ç–∞–≤–∏–º –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–º

    frontCams = scored
      .sort((a,b) => (b.scoreFront - b.penalty) - (a.scoreFront - a.penalty))
      .filter(x => x.scoreFront > 0 || (!x.label && x.deviceId));

    log('–ù–∞–π–¥–µ–Ω–æ –∫–∞–º–µ—Ä: –≤—Å–µ–≥–æ=' + vids.length +
        ' back=' + backCams.length + ' front=' + frontCams.length);

    // –õ–æ–≥ —Å–ø–∏—Å–∫–∞ (—É–∫–æ—Ä–æ—á–µ–Ω–Ω–æ)
    backCams.slice(0, 5).forEach((c, i) => log('back['+i+']: ' + (c.label || '(no label)')));
    frontCams.slice(0, 3).forEach((c, i) => log('front['+i+']: ' + (c.label || '(no label)')));
  }

  function buildConstraints({ useDeviceId, deviceId, facingMode }) {
    const baseVideo = {
      width: { ideal: 1920, min: 640 },
      height: { ideal: 1080, min: 480 },
      frameRate: { ideal: 30, min: 15 },
      aspectRatio: { ideal: 16 / 9 },
      // –∏–Ω–æ–≥–¥–∞ –ø–æ–º–æ–≥–∞–µ—Ç –∏–∑–±–µ–∂–∞—Ç—å —Å—Ç—Ä–∞–Ω–Ω–æ–≥–æ —Ä–µ—Å–∞–π–∑–∞:
      resizeMode: { ideal: 'none' }
    };

    if (useDeviceId && deviceId) {
      return { video: { ...baseVideo, deviceId: { exact: deviceId } }, audio: false };
    }

    // fallback –Ω–∞ facingMode
    return { video: { ...baseVideo, facingMode: { ideal: facingMode } }, audio: false };
  }

  async function startCamera() {
    stopCamera();

    const facingMode = useFrontCamera ? 'user' : 'environment';
    setStatus('–ó–∞–ø—É—Å–∫ –∫–∞–º–µ—Ä—ã...');
    log('–ó–∞–ø—É—Å–∫: ' + facingMode);

    // 1) –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º –æ—Ç–∫—Ä—ã—Ç—å –ø–æ facingMode (—ç—Ç–æ –¥–∞—ë—Ç —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ => –ø–æ—è–≤–ª—è—é—Ç—Å—è label)
    let stream = null;
    try {
      stream = await navigator.mediaDevices.getUserMedia(buildConstraints({
        useDeviceId: false,
        facingMode
      }));
      log('–ö–∞–º–µ—Ä–∞ OK (–ø–µ—Ä–≤–∏—á–Ω—ã–π —Å—Ç–∞—Ä—Ç –ø–æ facingMode)');
    } catch (e) {
      log('–°—Ç–∞—Ä—Ç –ø–æ facingMode fail: ' + e.name + ' / ' + e.message);
    }

    if (!stream) {
      setStatus('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ', 'error');
      return;
    }

    // –ü–æ–¥—Ü–µ–ø–∏–ª–∏ —Ç—Ä–µ–∫
    currentStream = stream;
    currentTrack = stream.getVideoTracks()[0];
    video.srcObject = stream;

    // –í–∞–∂–Ω–æ: –æ–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–∫–∏ –¥–µ–≤–∞–π—Å–æ–≤ –ø–æ—Å–ª–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è
    try { await refreshDeviceLists(); } catch (e) { log('enumerateDevices –æ—à–∏–±–∫–∞: ' + e.message); }

    // 2) –ï—Å–ª–∏ —ç—Ç–æ –∑–∞–¥–Ω—è—è –∫–∞–º–µ—Ä–∞ ‚Äî –≤—ã–±–∏—Ä–∞–µ–º ‚Äú–ª—É—á—à—É—é‚Äù –ø–æ deviceId –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –ø–æ—Ç–æ–∫
    if (!useFrontCamera) {
      const chosen = backCams[backIndex]?.deviceId;
      if (chosen) {
        log('–ü—Ä–æ–±—É—é –∑–∞–¥–Ω—é—é –ø–æ deviceId (index=' + backIndex + ')');
        // –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º deviceId
        try {
          stream.getTracks().forEach(t => t.stop());
          stream = await navigator.mediaDevices.getUserMedia(buildConstraints({
            useDeviceId: true,
            deviceId: chosen,
            facingMode
          }));
          currentStream = stream;
          currentTrack = stream.getVideoTracks()[0];
          video.srcObject = stream;
          log('–û—Ç–∫—Ä—ã—Ç–∞ –∑–∞–¥–Ω—è—è –∫–∞–º–µ—Ä–∞ –ø–æ deviceId ‚úÖ');
        } catch (e) {
          log('deviceId —Å—Ç–∞—Ä—Ç fail: ' + e.name + ' / ' + e.message);
          // –µ—Å–ª–∏ –Ω–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å ‚Äî –æ—Å—Ç–∞—ë–º—Å—è –Ω–∞ –ø–µ—Ä–≤–æ–º –ø–æ—Ç–æ–∫–µ
        }
      } else {
        log('back deviceId –Ω–µ –Ω–∞–π–¥–µ–Ω ‚Äî –æ—Å—Ç–∞—é—Å—å –Ω–∞ facingMode');
      }
    } else {
      const chosen = frontCams[frontIndex]?.deviceId;
      if (chosen) {
        log('–ü—Ä–æ–±—É—é —Ñ—Ä–æ–Ω—Ç –ø–æ deviceId (index=' + frontIndex + ')');
        try {
          stream.getTracks().forEach(t => t.stop());
          stream = await navigator.mediaDevices.getUserMedia(buildConstraints({
            useDeviceId: true,
            deviceId: chosen,
            facingMode
          }));
          currentStream = stream;
          currentTrack = stream.getVideoTracks()[0];
          video.srcObject = stream;
          log('–û—Ç–∫—Ä—ã—Ç–∞ —Ñ—Ä–æ–Ω—Ç –∫–∞–º–µ—Ä–∞ –ø–æ deviceId ‚úÖ');
        } catch (e) {
          log('front deviceId —Å—Ç–∞—Ä—Ç fail: ' + e.name + ' / ' + e.message);
        }
      }
    }

    // –õ–æ–≥ –Ω–∞—Å—Ç—Ä–æ–µ–∫
    try {
      const s = currentTrack.getSettings();
      log('Track settings: ' + (s.width||'?') + 'x' + (s.height||'?') +
          ' facing=' + (s.facingMode||'?') + ' deviceId=' + (s.deviceId ? 'yes' : 'no'));
    } catch (e) {}

    // –î–æ–∂–¥–∞—Ç—å—Å—è –≤–∏–¥–µ–æ –∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å
    try { await waitLoadedMetadata(video); } catch (e) { setStatus('–û—à–∏–±–∫–∞ –≤–∏–¥–µ–æ', 'error'); return; }

    // –ù–∞—Å—Ç—Ä–æ–∏—Ç—å —Ñ–æ–∫—É—Å –∏ –ø–æ–ø—ã—Ç–∞—Ç—å—Å—è —Ñ–æ—Ä—Å–Ω—É—Ç—å –∞–≤—Ç–æ—Ñ–æ–∫—É—Å
    await tuneTrackAndRefocus();

    flashOn = false;
    flashBtn.classList.remove('on');

    try { await video.play(); } catch (e) { setStatus('–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è', 'error'); return; }

    log('–í–∏–¥–µ–æ: ' + video.videoWidth + 'x' + video.videoHeight);
    setStatus('–ö–∞–º–µ—Ä–∞ –∞–∫—Ç–∏–≤–Ω–∞. –ò—â—É QR-–∫–æ–¥...');
    scanActive = true;
    requestScan();
  }

  async function tuneTrackAndRefocus() {
    if (!currentTrack?.getCapabilities) return;

    try {
      const caps = currentTrack.getCapabilities();
      log('Caps keys: ' + Object.keys(caps).join(', '));

      // 1) –°—Ç–∞–≤–∏–º continuous –µ—Å–ª–∏ –µ—Å—Ç—å
      if (caps.focusMode?.includes('continuous')) {
        await currentTrack.applyConstraints({ advanced: [{ focusMode: 'continuous' }] });
        log('‚Üí focusMode: continuous');
      }

      // 2) –§–æ—Ä—Å-—Ä–µ—Ñ–æ–∫—É—Å: single-shot, –∑–∞—Ç–µ–º –æ–±—Ä–∞—Ç–Ω–æ continuous
      if (caps.focusMode?.includes('single-shot')) {
        await currentTrack.applyConstraints({ advanced: [{ focusMode: 'single-shot' }] });
        log('‚Üí focusMode: single-shot (refocus)');
        // –Ω–µ–±–æ–ª—å—à–æ–π —Ç–∞–π–º–∞—É—Ç, —á—Ç–æ–±—ã –∫–∞–º–µ—Ä–∞ —É—Å–ø–µ–ª–∞ —Å—Ñ–æ–∫—É—Å–∏—Ä–æ–≤–∞—Ç—å—Å—è
        await new Promise(r => setTimeout(r, 250));
        if (caps.focusMode?.includes('continuous')) {
          await currentTrack.applyConstraints({ advanced: [{ focusMode: 'continuous' }] });
          log('‚Üí focusMode: continuous (after refocus)');
        }
      }

      // 3) –ï—Å–ª–∏ –≤—Å—ë —Ä–∞–≤–Ω–æ –º—ã–ª–æ ‚Äî –∏–Ω–æ–≥–¥–∞ –ø–æ–º–æ–≥–∞–µ—Ç –≤—ã—Å—Ç–∞–≤–∏—Ç—å focusDistance –±–ª–∏–∂–µ (–¥–ª—è QR)
      // –í–∞–∂–Ω–æ: –Ω–∞ —Ä–∞–∑–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö ‚Äúmin/max‚Äù –º–æ–≥—É—Ç —Ç—Ä–∞–∫—Ç–æ–≤–∞—Ç—å—Å—è –ø–æ-—Ä–∞–∑–Ω–æ–º—É,
      // –ø–æ—ç—Ç–æ–º—É –¥–µ–ª–∞–µ–º –º—è–≥–∫–æ: —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å –¥–∏–∞–ø–∞–∑–æ–Ω –∏ min != max.
      if (caps.focusDistance && caps.focusDistance.min != null && caps.focusDistance.max != null && caps.focusDistance.min !== caps.focusDistance.max) {
        // –î–ª—è QR –æ–±—ã—á–Ω–æ –Ω—É–∂–Ω–æ –±–ª–∏–∂–µ: –±–µ—Ä—ë–º min (–∫–∞–∫ –ø—Ä–∞–≤–∏–ª–æ ‚Äî –±–ª–∏–∂–Ω–∏–π —Ñ–æ–∫—É—Å).
        // –ï—Å–ª–∏ —É —Ç–µ–±—è –Ω–∞–æ–±–æ—Ä–æ—Ç —Å—Ç–∞–Ω–µ—Ç —Ö—É–∂–µ ‚Äî —Å–∫–∞–∂–∏, –ø–æ–º–µ–Ω—è–µ–º –Ω–∞ max/—Å–µ—Ä–µ–¥–∏–Ω—É.
        await currentTrack.applyConstraints({ advanced: [{ focusDistance: caps.focusDistance.min }] });
        log('‚Üí focusDistance: ' + caps.focusDistance.min + ' (near for QR)');
      }

      log('applyConstraints OK');
    } catch (e) {
      log('tune/refocus –æ—à–∏–±–∫–∞: ' + e.message);
    }
  }

  function stopCamera() {
    scanActive = false;
    if (animFrameId) { cancelAnimationFrame(animFrameId); animFrameId = null; }

    if (currentStream) {
      currentStream.getTracks().forEach(t => t.stop());
      currentStream = null;
      currentTrack = null;
    }
    video.srcObject = null;
  }

  // ====== –í–°–ü–´–®–ö–ê ======
  async function toggleFlash() {
    if (!currentTrack) return;
    try {
      const caps = currentTrack.getCapabilities ? currentTrack.getCapabilities() : {};
      if (!caps.torch) {
        setStatus('–í—Å–ø—ã—à–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞', 'warning');
        setTimeout(() => setStatus('–ö–∞–º–µ—Ä–∞ –∞–∫—Ç–∏–≤–Ω–∞. –ò—â—É QR-–∫–æ–¥...'), 2000);
        return;
      }
      flashOn = !flashOn;
      await currentTrack.applyConstraints({ advanced: [{ torch: flashOn }] });
      flashBtn.classList.toggle('on', flashOn);
      log('–í—Å–ø—ã—à–∫–∞: ' + (flashOn ? '–í–ö–õ' : '–í–´–ö–õ'));
    } catch (e) {
      log('–í—Å–ø—ã—à–∫–∞ –æ—à–∏–±–∫–∞: ' + e.message);
    }
  }

  // ====== –°–ö–ê–ù–ò–†–û–í–ê–ù–ò–ï ======
  function requestScan() {
    if (!scanActive) return;
    animFrameId = requestAnimationFrame(scanFrame);
  }

  function scanFrame() {
    if (!scanActive) return;
    if (video.readyState !== video.HAVE_ENOUGH_DATA) { requestScan(); return; }

    const w = video.videoWidth;
    const h = video.videoHeight;
    if (!w || !h) { requestScan(); return; }

    const cropW = Math.floor(w * SCAN_CENTER_FRACTION);
    const cropH = Math.floor(h * SCAN_CENTER_FRACTION);
    const cropX = Math.floor((w - cropW) / 2);
    const cropY = Math.floor((h - cropH) / 2);

    canvas.width = cropW;
    canvas.height = cropH;
    ctx.drawImage(video, cropX, cropY, cropW, cropH, 0, 0, cropW, cropH);

    let imageData;
    try {
      imageData = ctx.getImageData(0, 0, cropW, cropH);
    } catch (e) {
      requestScan();
      return;
    }

    const code = jsQR(imageData.data, cropW, cropH, { inversionAttempts: 'attemptBoth' });
    if (code && code.data) { onQRDetected(code.data); return; }

    requestScan();
  }

  function onQRDetected(qrData) {
    scanActive = false;
    log('QR: ' + qrData);
    setStatus('‚úÖ QR-–∫–æ–¥ —Å—á–∏—Ç–∞–Ω!', 'success');

    try { if (navigator.vibrate) navigator.vibrate(200); } catch (e) {}

    const payload = JSON.stringify({ event_id: eventId, qr_Data: qrData });
    log('Payload: ' + payload);

    if (isTelegram) {
      try {
        tg.sendData(payload);
        log('sendData() OK');
        setTimeout(() => { try { tg.close(); } catch(e) {} }, 2000);
      } catch (e) {
        log('sendData –æ—à–∏–±–∫–∞: ' + e.message);
        setStatus('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏', 'error');
        resumeScanAfterDelay();
      }
    } else {
      setStatus('QR: ' + qrData, 'success');
      resumeScanAfterDelay();
    }
  }

  function resumeScanAfterDelay() {
    setTimeout(() => {
      scanActive = true;
      requestScan();
      setStatus('–ö–∞–º–µ—Ä–∞ –∞–∫—Ç–∏–≤–Ω–∞. –ò—â—É QR-–∫–æ–¥...');
    }, 3000);
  }

  // ====== –ö–ù–û–ü–ö–ò ======
  switchBtn.addEventListener('click', () => {
    useFrontCamera = !useFrontCamera;
    log('–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ: ' + (useFrontCamera ? '—Ñ—Ä–æ–Ω—Ç' : '–∑–∞–¥–Ω—è—è'));
    startCamera();
  });

  lensBtn.addEventListener('click', async () => {
    // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º ‚Äú–ª–∏–Ω–∑—É‚Äù —Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–∏ —Ç–µ–∫—É—â–µ–≥–æ —Ä–µ–∂–∏–º–∞ (front/back)
    if (useFrontCamera) {
      if (frontCams.length <= 1) { setStatus('–ù–µ—Ç –¥—Ä—É–≥–∏—Ö —Ñ—Ä–æ–Ω—Ç –∫–∞–º–µ—Ä', 'warning'); return; }
      frontIndex = (frontIndex + 1) % frontCams.length;
      log('–õ–∏–Ω–∑–∞ —Ñ—Ä–æ–Ω—Ç: index=' + frontIndex);
    } else {
      if (backCams.length <= 1) { setStatus('–ù–µ—Ç –¥—Ä—É–≥–∏—Ö –∑–∞–¥–Ω–∏—Ö –∫–∞–º–µ—Ä', 'warning'); return; }
      backIndex = (backIndex + 1) % backCams.length;
      log('–õ–∏–Ω–∑–∞ –∑–∞–¥–Ω—è—è: index=' + backIndex);
    }
    startCamera();
  });

  flashBtn.addEventListener('click', () => toggleFlash());

  closeBtn.addEventListener('click', () => {
    stopCamera();
    if (isTelegram) { try { tg.close(); } catch(e) {} }
    setStatus('–°–∫–∞–Ω–µ—Ä –∑–∞–∫—Ä—ã—Ç');
  });

  // ====== –ó–ê–ü–£–°–ö ======
  if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
    log('getUserMedia OK');
    startCamera();
  } else {
    setStatus('–ö–∞–º–µ—Ä–∞ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è', 'error');
    log('getUserMedia –ù–ï –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è');
    if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
      setStatus('–ù—É–∂–µ–Ω HTTPS! –ü—Ä–æ—Ç–æ–∫–æ–ª: ' + location.protocol, 'error');
    }
  }
</script>

</body>
</html>