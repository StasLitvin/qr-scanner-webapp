<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>QR Scanner</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a2e;
            color: #ffffff;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .header {
            padding: 16px;
            text-align: center;
            width: 100%;
            background: #16213e;
        }

        .header h1 {
            font-size: 18px;
            font-weight: 600;
        }

        .header p {
            font-size: 13px;
            color: #a0a0b0;
            margin-top: 4px;
        }

        .scanner-container {
            position: relative;
            width: 100%;
            max-width: 400px;
            margin: 12px auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0 12px;
        }

        .video-wrapper {
            position: relative;
            width: 100%;
            border-radius: 12px;
            overflow: hidden;
            border: 2px solid #0f3460;
            background: #000;
        }

        #video {
            width: 100%;
            display: block;
        }

        .scan-region {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 200px;
            height: 200px;
            pointer-events: none;
        }

        .scan-region .corner {
            position: absolute;
            width: 30px;
            height: 30px;
            border-color: #e94560;
            border-style: solid;
            border-width: 0;
        }

        .corner.tl { top: 0; left: 0; border-top-width: 4px; border-left-width: 4px; border-radius: 8px 0 0 0; }
        .corner.tr { top: 0; right: 0; border-top-width: 4px; border-right-width: 4px; border-radius: 0 8px 0 0; }
        .corner.bl { bottom: 0; left: 0; border-bottom-width: 4px; border-left-width: 4px; border-radius: 0 0 0 8px; }
        .corner.br { bottom: 0; right: 0; border-bottom-width: 4px; border-right-width: 4px; border-radius: 0 0 8px 0; }

        .scan-line {
            position: absolute;
            left: 10%;
            width: 80%;
            height: 2px;
            background: #e94560;
            animation: scanAnimation 2s linear infinite;
        }

        @keyframes scanAnimation {
            0% { top: 10%; }
            50% { top: 90%; }
            100% { top: 10%; }
        }

        #canvas {
            display: none;
        }

        /* ====== ZOOM SLIDER ====== */
        .zoom-control {
            width: 100%;
            margin-top: 10px;
            padding: 10px 14px;
            background: #16213e;
            border-radius: 8px;
            display: none;
        }

        .zoom-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .zoom-label span {
            font-size: 13px;
            color: #a0a0b0;
        }

        .zoom-label .zoom-value {
            font-size: 14px;
            font-weight: 600;
            color: #e94560;
            min-width: 40px;
            text-align: right;
        }

        .zoom-slider-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .zoom-icon {
            font-size: 16px;
            color: #a0a0b0;
            flex-shrink: 0;
            user-select: none;
        }

        .zoom-slider-row input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #0d0d1a;
            outline: none;
        }

        .zoom-slider-row input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: #e94560;
            cursor: pointer;
            border: 2px solid #fff;
            box-shadow: 0 0 6px rgba(233, 69, 96, 0.5);
        }

        .zoom-slider-row input[type="range"]::-moz-range-thumb {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: #e94560;
            cursor: pointer;
            border: 2px solid #fff;
            box-shadow: 0 0 6px rgba(233, 69, 96, 0.5);
        }

        .zoom-presets {
            display: flex;
            gap: 6px;
            margin-top: 8px;
        }

        .zoom-preset-btn {
            flex: 1;
            padding: 6px 0;
            border: 1px solid #0f3460;
            border-radius: 6px;
            background: transparent;
            color: #a0a0b0;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .zoom-preset-btn.active {
            background: #e94560;
            border-color: #e94560;
            color: #fff;
        }

        .zoom-preset-btn:active {
            transform: scale(0.95);
        }

        /* ====== STATUS & BUTTONS ====== */
        .status {
            margin-top: 12px;
            padding: 12px 20px;
            background: #16213e;
            border-radius: 8px;
            font-size: 14px;
            text-align: center;
            width: 100%;
        }

        .status.success {
            background: #1b5e20;
        }

        .status.error {
            background: #b71c1c;
        }

        .status.warning {
            background: #e65100;
        }

        .btn-row {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            width: 100%;
        }

        .btn {
            flex: 1;
            padding: 12px 16px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            color: #fff;
            transition: background 0.2s;
        }

        .btn-switch {
            background: #0f3460;
        }

        .btn-switch:active {
            background: #1a5276;
        }

        .btn-flash {
            background: #533483;
        }

        .btn-flash:active {
            background: #6c44a2;
        }

        .btn-flash.on {
            background: #f0a500;
            color: #1a1a2e;
        }

        .btn-close {
            background: #b71c1c;
        }

        .btn-close:active {
            background: #d32f2f;
        }

        .debug {
            margin-top: 8px;
            padding: 8px 12px;
            background: #0d0d1a;
            border-radius: 6px;
            font-size: 11px;
            color: #666;
            width: 100%;
            max-height: 80px;
            overflow-y: auto;
            word-break: break-all;
        }
    </style>
</head>
<body>

<div class="header">
    <h1>–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ QR-–∫–æ–¥–∞</h1>
    <p>–ù–∞–≤–µ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ QR-–∫–æ–¥ —É—á–∞—Å—Ç–Ω–∏–∫–∞</p>
</div>

<div class="scanner-container">

    <!-- –í–∏–¥–µ–æ -->
    <div class="video-wrapper">
        <video id="video" autoplay playsinline muted></video>
        <div class="scan-region">
            <div class="corner tl"></div>
            <div class="corner tr"></div>
            <div class="corner bl"></div>
            <div class="corner br"></div>
            <div class="scan-line"></div>
        </div>
    </div>

    <canvas id="canvas"></canvas>

    <!-- –°–ª–∞–π–¥–µ—Ä –∑—É–º–∞ -->
    <div class="zoom-control" id="zoomControl">
        <div class="zoom-label">
            <span>–ú–∞—Å—à—Ç–∞–± –∫–∞–º–µ—Ä—ã</span>
            <span class="zoom-value" id="zoomValue">1.0x</span>
        </div>
        <div class="zoom-slider-row">
            <span class="zoom-icon">‚àí</span>
            <input type="range" id="zoomSlider" min="1" max="10" step="0.1" value="1">
            <span class="zoom-icon">+</span>
        </div>
        <div class="zoom-presets" id="zoomPresets"></div>
    </div>

    <!-- –°—Ç–∞—Ç—É—Å -->
    <div class="status" id="status">–ó–∞–ø—É—Å–∫ –∫–∞–º–µ—Ä—ã...</div>

    <!-- –ö–Ω–æ–ø–∫–∏ -->
    <div class="btn-row">
        <button class="btn btn-switch" id="switchBtn">üì∑ –ö–∞–º–µ—Ä–∞</button>
        <button class="btn btn-flash" id="flashBtn">üî¶ –í—Å–ø—ã—à–∫–∞</button>
        <button class="btn btn-close" id="closeBtn">‚úï –ó–∞–∫—Ä—ã—Ç—å</button>
    </div>

    <!-- –õ–æ–≥ -->
    <div class="debug" id="debug">–õ–æ–≥: –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>

<script>
    // ====== –≠–õ–ï–ú–ï–ù–¢–´ ======
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d', { willReadFrequently: true });
    const statusEl = document.getElementById('status');
    const debugEl = document.getElementById('debug');
    const switchBtn = document.getElementById('switchBtn');
    const flashBtn = document.getElementById('flashBtn');
    const closeBtn = document.getElementById('closeBtn');
    const zoomControl = document.getElementById('zoomControl');
    const zoomSlider = document.getElementById('zoomSlider');
    const zoomValueEl = document.getElementById('zoomValue');
    const zoomPresetsEl = document.getElementById('zoomPresets');

    // ====== –°–û–°–¢–û–Ø–ù–ò–ï ======
    let currentStream = null;
    let currentTrack = null;
    let useFrontCamera = false;
    let flashOn = false;
    let scanActive = true;
    let animFrameId = null;
    let zoomCapabilities = null;

    // ====== –ù–ê–°–¢–†–û–ô–ö–ê: —Å–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ —Ü–µ–Ω—Ç—Ä –∫–∞–¥—Ä–∞ ======
    // –î–æ–ª—è –æ—Ç –ø–æ–ª–Ω–æ–≥–æ –∫–∞–¥—Ä–∞ (0.5 = —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–µ 50%)
    const SCAN_CENTER_FRACTION = 0.6;

    // event_id –∏–∑ URL
    const urlParams = new URLSearchParams(window.location.search);
    const eventId = urlParams.get('event_id') || '0';

    // Telegram WebApp
    let tg = null;
    let isTelegram = false;
    try {
        if (window.Telegram && window.Telegram.WebApp) {
            tg = window.Telegram.WebApp;
            tg.expand();
            tg.ready();
            isTelegram = true;
            log('Telegram WebApp –æ–±–Ω–∞—Ä—É–∂–µ–Ω');
        } else {
            log('–ê–≤—Ç–æ–Ω–æ–º–Ω—ã–π —Ä–µ–∂–∏–º (–±–µ–∑ Telegram)');
        }
    } catch (e) {
        log('–û—à–∏–±–∫–∞ Telegram WebApp: ' + e.message);
    }

    log('event_id = ' + eventId);

    // ====== –õ–û–ì–ò–†–û–í–ê–ù–ò–ï ======
    function log(msg) {
        const time = new Date().toLocaleTimeString();
        debugEl.textContent = time + ' | ' + msg;
        console.log('[QR]', msg);
    }

    function setStatus(text, cls) {
        statusEl.textContent = text;
        statusEl.className = 'status' + (cls ? ' ' + cls : '');
    }

    // ====== –ö–ê–ú–ï–†–ê ======
    async function startCamera() {
        stopCamera();

        const facingMode = useFrontCamera ? 'user' : 'environment';
        log('–ó–∞–ø—É—Å–∫ –∫–∞–º–µ—Ä—ã: ' + facingMode);
        setStatus('–ó–∞–ø—É—Å–∫ –∫–∞–º–µ—Ä—ã...');

        // ============================================================
        // –ö–õ–Æ–ß–ï–í–û–ï –ò–ó–ú–ï–ù–ï–ù–ò–ï ‚Ññ1:
        // –ù–µ —É–∫–∞–∑—ã–≤–∞–µ–º –∂—ë—Å—Ç–∫–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ ‚Äî –ø—É—Å—Ç—å –∫–∞–º–µ—Ä–∞ —Å–∞–º–∞ –≤—ã–±–µ—Ä–µ—Ç
        // –Ω–∞—Ç–∏–≤–Ω–æ–µ. –£–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ facingMode + –∞–≤—Ç–æ—Ñ–æ–∫—É—Å.
        // –ñ—ë—Å—Ç–∫–∏–π ideal: 1280√ó720 –Ω–∞ –º–Ω–æ–≥–∏—Ö —Ç–µ–ª–µ—Ñ–æ–Ω–∞—Ö –≤—ã–∑—ã–≤–∞–µ—Ç
        // —Ü–∏—Ñ—Ä–æ–≤–æ–π –∫—Ä–æ–ø (–∫–∞–º–µ—Ä–∞ ¬´–∑—É–º–∏—Ç¬ª –ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ) ‚Üí —Å–º–∞–∑–∞–Ω–Ω–æ—Å—Ç—å.
        // ============================================================
        const constraintsList = [
            {
                video: {
                    facingMode: { exact: facingMode },
                    // –ü—Ä–æ—Å–∏–º —à–∏—Ä–æ–∫–æ—É–≥–æ–ª—å–Ω–æ–µ –ø–æ–ª–µ –∑—Ä–µ–Ω–∏—è –±–µ–∑ –∫—Ä–æ–ø–∞
                    resizeMode: 'none',
                    // –ê–≤—Ç–æ—Ñ–æ–∫—É—Å –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω—ã–π ‚Äî –ö–†–ò–¢–ò–ß–ù–û –¥–ª—è —á—ë—Ç–∫–æ—Å—Ç–∏
                    focusMode: 'continuous'
                },
                audio: false
            },
            {
                video: {
                    facingMode: facingMode,
                    focusMode: 'continuous'
                },
                audio: false
            },
            {
                // –°–æ–≤—Å–µ–º –ø—Ä–æ—Å—Ç–æ–π –≤–∞—Ä–∏–∞–Ω—Ç ‚Äî –ø—Ä–æ—Å—Ç–æ –∫–∞–º–µ—Ä–∞
                video: {
                    facingMode: { ideal: facingMode }
                },
                audio: false
            },
            {
                video: true,
                audio: false
            }
        ];

        let stream = null;
        for (let i = 0; i < constraintsList.length; i++) {
            try {
                stream = await navigator.mediaDevices.getUserMedia(constraintsList[i]);
                log('–ö–∞–º–µ—Ä–∞ –∑–∞–ø—É—â–µ–Ω–∞ (–≤–∞—Ä–∏–∞–Ω—Ç ' + (i + 1) + ')');
                break;
            } catch (err) {
                log('–í–∞—Ä–∏–∞–Ω—Ç ' + (i + 1) + ': ' + err.message);
            }
        }

        if (!stream) {
            setStatus('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ', 'error');
            log('–í—Å–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –∫–∞–º–µ—Ä—ã –ø—Ä–æ–≤–∞–ª–∏–ª–∏—Å—å');
            return;
        }

        currentStream = stream;
        currentTrack = stream.getVideoTracks()[0];
        video.srcObject = stream;

        // ============================================================
        // –ö–õ–Æ–ß–ï–í–û–ï –ò–ó–ú–ï–ù–ï–ù–ò–ï ‚Ññ2:
        // –ü–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è —Ç—Ä–µ–∫–∞ ‚Äî –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –≤–∫–ª—é—á–∞–µ–º –∞–≤—Ç–æ—Ñ–æ–∫—É—Å
        // –∏ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –∑—É–º –Ω–∞ –º–∏–Ω–∏–º—É–º —á–µ—Ä–µ–∑ applyConstraints.
        // ============================================================
        await enableAutoFocusAndResetZoom();

        // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º UI –∑—É–º–∞
        await setupZoom();

        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Å–ø—ã—à–∫—É
        flashOn = false;
        flashBtn.classList.remove('on');

        video.onloadedmetadata = () => {
            video.play().then(() => {
                log('–í–∏–¥–µ–æ: ' + video.videoWidth + 'x' + video.videoHeight);
                setStatus('–ö–∞–º–µ—Ä–∞ –∞–∫—Ç–∏–≤–Ω–∞. –ò—â—É QR-–∫–æ–¥...');
                scanActive = true;
                requestScan();
            }).catch(err => {
                log('–û—à–∏–±–∫–∞ play(): ' + err.message);
                setStatus('–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è', 'error');
            });
        };

        video.onerror = () => {
            log('–û—à–∏–±–∫–∞ –≤–∏–¥–µ–æ —ç–ª–µ–º–µ–Ω—Ç–∞');
            setStatus('–û—à–∏–±–∫–∞ –≤–∏–¥–µ–æ', 'error');
        };
    }

    // ============================================================
    // –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –≤–∫–ª—é—á–∞–µ–º –∞–≤—Ç–æ—Ñ–æ–∫—É—Å + —Å–±—Ä–æ—Å –∑—É–º–∞
    // ============================================================
    async function enableAutoFocusAndResetZoom() {
        if (!currentTrack) return;

        try {
            const capabilities = currentTrack.getCapabilities();

            const advancedConstraints = [];

            // --- –ê–≤—Ç–æ—Ñ–æ–∫—É—Å ---
            if (capabilities.focusMode && capabilities.focusMode.includes('continuous')) {
                advancedConstraints.push({ focusMode: 'continuous' });
                log('–ê–≤—Ç–æ—Ñ–æ–∫—É—Å: continuous');
            } else if (capabilities.focusMode && capabilities.focusMode.includes('auto')) {
                advancedConstraints.push({ focusMode: 'auto' });
                log('–ê–≤—Ç–æ—Ñ–æ–∫—É—Å: auto');
            } else {
                log('–ê–≤—Ç–æ—Ñ–æ–∫—É—Å: –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è (' +
                    (capabilities.focusMode || []).join(',') + ')');
            }

            // --- –°–±—Ä–æ—Å –∑—É–º–∞ –Ω–∞ –º–∏–Ω–∏–º—É–º ---
            if (capabilities.zoom) {
                advancedConstraints.push({ zoom: capabilities.zoom.min });
                log('Zoom —Å–±—Ä–æ—à–µ–Ω –Ω–∞ ' + capabilities.zoom.min);
            }

            if (advancedConstraints.length > 0) {
                await currentTrack.applyConstraints({
                    advanced: advancedConstraints
                });
            }
        } catch (e) {
            log('enableAutoFocus –æ—à–∏–±–∫–∞: ' + e.message);
        }
    }

    function stopCamera() {
        scanActive = false;
        if (animFrameId) {
            cancelAnimationFrame(animFrameId);
            animFrameId = null;
        }
        if (currentStream) {
            currentStream.getTracks().forEach(track => {
                track.stop();
            });
            currentStream = null;
            currentTrack = null;
        }
        video.srcObject = null;
        zoomControl.style.display = 'none';
        zoomCapabilities = null;
    }

    // ====== –ù–ê–°–¢–†–û–ô–ö–ê –ó–£–ú–ê ======
    async function setupZoom() {
        if (!currentTrack) return;

        try {
            const capabilities = currentTrack.getCapabilities();

            if (capabilities.zoom) {
                zoomCapabilities = capabilities.zoom;

                const minZ = zoomCapabilities.min;
                const maxZ = zoomCapabilities.max;
                const stepZ = zoomCapabilities.step || 0.1;

                log('Zoom: min=' + minZ + ' max=' + maxZ + ' step=' + stepZ);

                zoomSlider.min = minZ;
                zoomSlider.max = maxZ;
                zoomSlider.step = stepZ;
                zoomSlider.value = minZ;
                zoomValueEl.textContent = minZ.toFixed(1) + 'x';

                createZoomPresets(minZ, maxZ);

                zoomControl.style.display = 'block';
            } else {
                log('–ö–∞–º–µ—Ä–∞ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç zoom');
                zoomControl.style.display = 'none';
            }
        } catch (e) {
            log('getCapabilities –æ—à–∏–±–∫–∞: ' + e.message);
            zoomControl.style.display = 'none';
        }
    }

    async function applyZoom(value) {
        if (!currentTrack) return;
        try {
            await currentTrack.applyConstraints({
                advanced: [{ zoom: value }]
            });
        } catch (e) {
            log('applyZoom –æ—à–∏–±–∫–∞: ' + e.message);
        }
    }

    function createZoomPresets(minZ, maxZ) {
        zoomPresetsEl.innerHTML = '';

        const presets = [];
        presets.push({ label: minZ.toFixed(1) + 'x', value: minZ });

        const range = maxZ - minZ;
        if (range > 0.5) {
            const quarter = minZ + range * 0.25;
            presets.push({ label: quarter.toFixed(1) + 'x', value: quarter });
        }
        if (range > 1) {
            const half = minZ + range * 0.5;
            presets.push({ label: half.toFixed(1) + 'x', value: half });
        }
        if (range > 2) {
            const three = minZ + range * 0.75;
            presets.push({ label: three.toFixed(1) + 'x', value: three });
        }

        presets.push({ label: maxZ.toFixed(1) + 'x', value: maxZ });

        const unique = [];
        const seen = new Set();
        for (const p of presets) {
            const key = p.value.toFixed(1);
            if (!seen.has(key)) {
                seen.add(key);
                unique.push(p);
            }
        }

        unique.forEach((preset, idx) => {
            const btn = document.createElement('button');
            btn.className = 'zoom-preset-btn' + (idx === 0 ? ' active' : '');
            btn.textContent = preset.label;
            btn.addEventListener('click', async () => {
                zoomSlider.value = preset.value;
                zoomValueEl.textContent = preset.value.toFixed(1) + 'x';
                await applyZoom(preset.value);
                updatePresetActive(preset.value);
            });
            zoomPresetsEl.appendChild(btn);
        });
    }

    function updatePresetActive(currentValue) {
        const btns = zoomPresetsEl.querySelectorAll('.zoom-preset-btn');
        btns.forEach(btn => {
            const btnVal = parseFloat(btn.textContent);
            if (Math.abs(btnVal - currentValue) < 0.05) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
        });
    }

    zoomSlider.addEventListener('input', async () => {
        const val = parseFloat(zoomSlider.value);
        zoomValueEl.textContent = val.toFixed(1) + 'x';
        await applyZoom(val);
        updatePresetActive(val);
    });

    // ====== –í–°–ü–´–®–ö–ê (–§–û–ù–ê–†–ò–ö) ======
    async function toggleFlash() {
        if (!currentTrack) return;

        try {
            const capabilities = currentTrack.getCapabilities();
            if (!capabilities.torch) {
                log('–í—Å–ø—ã—à–∫–∞ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è');
                setStatus('–í—Å–ø—ã—à–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞', 'warning');
                setTimeout(() => setStatus('–ö–∞–º–µ—Ä–∞ –∞–∫—Ç–∏–≤–Ω–∞. –ò—â—É QR-–∫–æ–¥...'), 2000);
                return;
            }

            flashOn = !flashOn;
            await currentTrack.applyConstraints({
                advanced: [{ torch: flashOn }]
            });

            flashBtn.classList.toggle('on', flashOn);
            log('–í—Å–ø—ã—à–∫–∞: ' + (flashOn ? '–í–ö–õ' : '–í–´–ö–õ'));
        } catch (e) {
            log('–û—à–∏–±–∫–∞ –≤—Å–ø—ã—à–∫–∏: ' + e.message);
        }
    }

    // ====== –°–ö–ê–ù–ò–†–û–í–ê–ù–ò–ï ======
    function requestScan() {
        if (!scanActive) return;
        animFrameId = requestAnimationFrame(scanFrame);
    }

    // ============================================================
    // –ö–õ–Æ–ß–ï–í–û–ï –ò–ó–ú–ï–ù–ï–ù–ò–ï ‚Ññ3:
    // –°–∫–∞–Ω–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –¶–ï–ù–¢–†–ê–õ–¨–ù–£–Æ —á–∞—Å—Ç—å –∫–∞–¥—Ä–∞.
    // –≠—Ç–æ –±—ã—Å—Ç—Ä–µ–µ + —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ç–æ–º—É, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç
    // –≤ —Ä–∞–º–∫–µ –ø—Ä–∏—Ü–µ–ª–∞. –¢–∞–∫–∂–µ –ø—Ä–æ–±—É–µ–º inversionAttempts: 'attemptBoth'
    // –¥–ª—è –ª—É—á—à–µ–≥–æ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è.
    // ============================================================
    function scanFrame() {
        if (!scanActive) return;

        if (video.readyState !== video.HAVE_ENOUGH_DATA) {
            requestScan();
            return;
        }

        const w = video.videoWidth;
        const h = video.videoHeight;

        if (w === 0 || h === 0) {
            requestScan();
            return;
        }

        // –í—ã—Ä–µ–∑–∞–µ–º —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω—É—é –æ–±–ª–∞—Å—Ç—å (SCAN_CENTER_FRACTION –æ—Ç –∫–∞–¥—Ä–∞)
        const cropW = Math.floor(w * SCAN_CENTER_FRACTION);
        const cropH = Math.floor(h * SCAN_CENTER_FRACTION);
        const cropX = Math.floor((w - cropW) / 2);
        const cropY = Math.floor((h - cropH) / 2);

        canvas.width = cropW;
        canvas.height = cropH;

        // –†–∏—Å—É–µ–º —Ç–æ–ª—å–∫–æ —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π –∫—É—Å–æ–∫
        ctx.drawImage(video, cropX, cropY, cropW, cropH, 0, 0, cropW, cropH);

        let imageData;
        try {
            imageData = ctx.getImageData(0, 0, cropW, cropH);
        } catch (e) {
            log('getImageData –æ—à–∏–±–∫–∞: ' + e.message);
            requestScan();
            return;
        }

        const code = jsQR(imageData.data, cropW, cropH, {
            inversionAttempts: 'attemptBoth'
        });

        if (code && code.data) {
            onQRDetected(code.data);
            return;
        }

        requestScan();
    }

    // ====== QR –ù–ê–ô–î–ï–ù ======
    function onQRDetected(qrData) {
        scanActive = false;
        log('QR: ' + qrData);
        setStatus('‚úÖ QR-–∫–æ–¥ —Å—á–∏—Ç–∞–Ω!', 'success');

        try {
            if (navigator.vibrate) navigator.vibrate(200);
        } catch (e) {}

        const payload = JSON.stringify({
            event_id: eventId,
            "qr_Data": qrData
        });

        log('Payload: ' + payload);

        if (isTelegram) {
            try {
                tg.sendData(payload);
                log('sendData() –≤—ã–∑–≤–∞–Ω');
                setTimeout(() => {
                    try { tg.close(); } catch(e) {}
                }, 2000);
            } catch (e) {
                log('sendData –æ—à–∏–±–∫–∞: ' + e.message);
                setStatus('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏', 'error');
                resumeScanAfterDelay();
            }
        } else {
            setStatus('QR: ' + qrData, 'success');
            log('–ê–≤—Ç–æ–Ω–æ–º–Ω—ã–π —Ä–µ–∂–∏–º ‚Äî –¥–∞–Ω–Ω—ã–µ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã');
            resumeScanAfterDelay();
        }
    }

    function resumeScanAfterDelay() {
        setTimeout(() => {
            scanActive = true;
            requestScan();
            setStatus('–ö–∞–º–µ—Ä–∞ –∞–∫—Ç–∏–≤–Ω–∞. –ò—â—É QR-–∫–æ–¥...');
        }, 3000);
    }

    // ====== –ö–ù–û–ü–ö–ò ======
    switchBtn.addEventListener('click', () => {
        useFrontCamera = !useFrontCamera;
        log('–ö–∞–º–µ—Ä–∞: ' + (useFrontCamera ? '—Ñ—Ä–æ–Ω—Ç–∞–ª—å–Ω–∞—è' : '–∑–∞–¥–Ω—è—è'));
        startCamera();
    });

    flashBtn.addEventListener('click', () => {
        toggleFlash();
    });

    closeBtn.addEventListener('click', () => {
        stopCamera();
        if (isTelegram) {
            try { tg.close(); } catch(e) {}
        }
        setStatus('–°–∫–∞–Ω–µ—Ä –∑–∞–∫—Ä—ã—Ç');
    });

    // ====== –ó–ê–ü–£–°–ö ======
    if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
        log('getUserMedia –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è');
        startCamera();
    } else {
        setStatus('–ö–∞–º–µ—Ä–∞ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è', 'error');
        log('getUserMedia –ù–ï –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è');

        if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
            log('–°—Ç—Ä–∞–Ω–∏—Ü–∞ –æ—Ç–∫—Ä—ã—Ç–∞ –Ω–µ —á–µ—Ä–µ–∑ HTTPS!');
            setStatus('–ù—É–∂–µ–Ω HTTPS –¥–ª—è –∫–∞–º–µ—Ä—ã. –ü—Ä–æ—Ç–æ–∫–æ–ª: ' + location.protocol, 'error');
        }
    }
</script>

</body>
</html>
