<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>QR Scanner</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #1a1a2e;
      color: #ffffff;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .header {
      padding: 16px;
      text-align: center;
      width: 100%;
      background: #16213e;
    }

    .header h1 { font-size: 18px; font-weight: 600; }
    .header p { font-size: 13px; color: #a0a0b0; margin-top: 4px; }

    .scanner-container {
      position: relative;
      width: 100%;
      max-width: 400px;
      margin: 12px auto;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 0 12px;
    }

    .video-wrapper {
      position: relative;
      width: 100%;
      border-radius: 12px;
      overflow: hidden;
      border: 2px solid #0f3460;
      background: #000;
    }

    #video {
      width: 100%;
      display: block;
      object-fit: cover;
    }

    .scan-region {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 200px;
      height: 200px;
      pointer-events: none;
    }

    .scan-region .corner {
      position: absolute;
      width: 30px;
      height: 30px;
      border-color: #e94560;
      border-style: solid;
      border-width: 0;
    }

    .corner.tl { top: 0; left: 0; border-top-width: 4px; border-left-width: 4px; border-radius: 8px 0 0 0; }
    .corner.tr { top: 0; right: 0; border-top-width: 4px; border-right-width: 4px; border-radius: 0 8px 0 0; }
    .corner.bl { bottom: 0; left: 0; border-bottom-width: 4px; border-left-width: 4px; border-radius: 0 0 0 8px; }
    .corner.br { bottom: 0; right: 0; border-bottom-width: 4px; border-right-width: 4px; border-radius: 0 0 8px 0; }

    .scan-line {
      position: absolute;
      left: 10%;
      width: 80%;
      height: 2px;
      background: #e94560;
      animation: scanAnimation 2s linear infinite;
    }

    @keyframes scanAnimation {
      0%   { top: 10%; }
      50%  { top: 90%; }
      100% { top: 10%; }
    }

    #canvas { display: none; }

    .status {
      margin-top: 12px;
      padding: 12px 20px;
      background: #16213e;
      border-radius: 8px;
      font-size: 14px;
      text-align: center;
      width: 100%;
    }

    .status.success { background: #1b5e20; }
    .status.error   { background: #b71c1c; }
    .status.warning { background: #e65100; }

    .btn-row {
      display: flex;
      gap: 8px;
      margin-top: 12px;
      width: 100%;
      flex-wrap: wrap;
    }

    .btn {
      flex: 1 1 calc(50% - 8px);
      padding: 12px 16px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
      color: #fff;
      transition: background 0.2s;
    }

    .btn-switch { background: #0f3460; }
    .btn-switch:active { background: #1a5276; }
    .btn-lens { background: #0b6b53; }
    .btn-lens:active { background: #0f8a6a; }
    .btn-flash { background: #533483; }
    .btn-flash:active { background: #6c44a2; }
    .btn-flash.on { background: #f0a500; color: #1a1a2e; }
    .btn-close { background: #b71c1c; }
    .btn-close:active { background: #d32f2f; }

    .debug {
      margin-top: 8px;
      padding: 8px 12px;
      background: #0d0d1a;
      border-radius: 6px;
      font-size: 11px;
      color: #666;
      width: 100%;
      max-height: 140px;
      overflow-y: auto;
      word-break: break-all;
    }
  </style>
</head>
<body>

<div class="header">
  <h1>–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ QR-–∫–æ–¥–∞</h1>
  <p>–ù–∞–≤–µ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ QR-–∫–æ–¥ —É—á–∞—Å—Ç–Ω–∏–∫–∞</p>
</div>

<div class="scanner-container">
  <div class="video-wrapper">
    <video id="video" autoplay playsinline muted></video>
    <div class="scan-region">
      <div class="corner tl"></div>
      <div class="corner tr"></div>
      <div class="corner bl"></div>
      <div class="corner br"></div>
      <div class="scan-line"></div>
    </div>
  </div>

  <canvas id="canvas"></canvas>

  <div class="status" id="status">–ó–∞–ø—É—Å–∫ –∫–∞–º–µ—Ä—ã...</div>

  <div class="btn-row">
    <button class="btn btn-switch" id="switchBtn">üì∑ –ö–∞–º–µ—Ä–∞</button>
    <button class="btn btn-lens" id="lensBtn">üîÅ –õ–∏–Ω–∑–∞</button>
    <button class="btn btn-flash" id="flashBtn">üî¶ –í—Å–ø—ã—à–∫–∞</button>
    <button class="btn btn-close" id="closeBtn">‚úï –ó–∞–∫—Ä—ã—Ç—å</button>
  </div>

  <div class="debug" id="debug">–õ–æ–≥: –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...</div>
</div>

<script>
  // =============================================
  // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
  // =============================================
  var video     = document.getElementById('video');
  var canvas    = document.getElementById('canvas');
  var ctx       = canvas.getContext('2d', { willReadFrequently: true });
  var statusEl  = document.getElementById('status');
  var debugEl   = document.getElementById('debug');
  var switchBtn = document.getElementById('switchBtn');
  var lensBtn   = document.getElementById('lensBtn');
  var flashBtn  = document.getElementById('flashBtn');
  var closeBtn  = document.getElementById('closeBtn');

  var currentStream = null;
  var currentTrack  = null;

  var useFrontCamera = false;
  var flashOn        = false;
  var scanActive     = true;
  var animFrameId    = null;
  var jsQRReady      = false;

  var debugLines = [];

  var SCAN_CENTER_FRACTION = 0.6;

  var backCams   = [];
  var frontCams  = [];
  var backIndex  = 0;
  var frontIndex = 0;

  var urlParams = new URLSearchParams(window.location.search);
  var eventId   = urlParams.get('event_id') || '0';

  var tg         = null;
  var isTelegram = false;

  // =============================================
  // –£—Ç–∏–ª–∏—Ç—ã
  // =============================================
  function log(msg) {
    var time = new Date().toLocaleTimeString();
    var line = time + ' | ' + msg;
    debugLines.push(line);
    if (debugLines.length > 18) { debugLines.shift(); }
    debugEl.textContent = debugLines.join('\n');
    debugEl.scrollTop = debugEl.scrollHeight;
    console.log('[QR]', msg);
  }

  function setStatus(text, cls) {
    statusEl.textContent = text;
    statusEl.className = 'status' + (cls ? ' ' + cls : '');
  }

  function waitLoadedMetadata(v) {
    return new Promise(function(resolve, reject) {
      function ok()  { cleanup(); resolve(); }
      function err() { cleanup(); reject(new Error('video metadata error')); }
      function cleanup() {
        v.removeEventListener('loadedmetadata', ok);
        v.removeEventListener('error', err);
      }
      v.addEventListener('loadedmetadata', ok,  { once: true });
      v.addEventListener('error',          err, { once: true });
    });
  }

  // =============================================
  // Telegram WebApp
  // =============================================
  try {
    if (window.Telegram && window.Telegram.WebApp) {
      tg = window.Telegram.WebApp;
      tg.expand();
      tg.ready();
      isTelegram = true;
      log('Telegram WebApp –æ–±–Ω–∞—Ä—É–∂–µ–Ω');
    } else {
      log('–ê–≤—Ç–æ–Ω–æ–º–Ω—ã–π —Ä–µ–∂–∏–º');
    }
  } catch (e) {
    log('TG –æ—à–∏–±–∫–∞: ' + e.message);
  }

  log('event_id = ' + eventId);

  // =============================================
  // –ó–∞–≥—Ä—É–∑–∫–∞ jsQR (–ª–æ–∫–∞–ª—å–Ω–æ, —Å CDN-—Ñ–æ–ª–±—ç–∫–æ–º)
  // =============================================
  function loadJsQR() {
    return new Promise(function(resolve, reject) {
      // –ï—Å–ª–∏ —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω (–Ω–∞–ø—Ä–∏–º–µ—Ä, –±—ã–ª inline)
      if (typeof jsQR === 'function') {
        log('jsQR —É–∂–µ –¥–æ—Å—Ç—É–ø–µ–Ω');
        resolve();
        return;
      }

      var sources = [
        '/static/js/jsQR.min.js',
        'https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js',
        'https://unpkg.com/jsqr@1.4.0/dist/jsQR.min.js'
      ];

      var index = 0;

      function tryNext() {
        if (index >= sources.length) {
          reject(new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å jsQR –Ω–∏ –∏–∑ –æ–¥–Ω–æ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞'));
          return;
        }

        var src = sources[index];
        index++;
        log('–ó–∞–≥—Ä—É–∑–∫–∞ jsQR: ' + src);

        var script  = document.createElement('script');
        script.src  = src;
        script.onload = function() {
          if (typeof jsQR === 'function') {
            log('jsQR –∑–∞–≥—Ä—É–∂–µ–Ω OK: ' + src);
            resolve();
          } else {
            log('jsQR –∑–∞–≥—Ä—É–∂–µ–Ω, –Ω–æ —Ñ—É–Ω–∫—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞: ' + src);
            tryNext();
          }
        };
        script.onerror = function() {
          log('jsQR –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω: ' + src);
          tryNext();
        };
        document.head.appendChild(script);
      }

      tryNext();
    });
  }

  // =============================================
  // –ö–∞–º–µ—Ä—ã: –ø–æ—Å—Ç—Ä–æ–∏—Ç—å —Å–ø–∏—Å–æ–∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤
  // =============================================
  function refreshDeviceLists() {
    if (!navigator.mediaDevices || !navigator.mediaDevices.enumerateDevices) {
      return Promise.resolve();
    }

    return navigator.mediaDevices.enumerateDevices().then(function(devices) {
      var vids = devices.filter(function(d) { return d.kind === 'videoinput'; });

      var isBack    = function(label) { return /back|rear|environment/i.test(label); };
      var isFront   = function(label) { return /front|user|selfie/i.test(label); };
      var isBadAux  = function(label) { return /macro|depth|tof|aux/i.test(label); };

      var scored = vids.map(function(d) {
        var label = (d.label || '').trim();
        var scoreBack = 0;
        var scoreFront = 0;
        var penalty = 0;

        if (isBack(label))   { scoreBack  += 10; }
        if (isFront(label))  { scoreFront += 10; }
        if (isBadAux(label)) { penalty    += 8;  }
        if (/ultra|wide/i.test(label)) { penalty += 2; }

        return {
          deviceId:   d.deviceId,
          label:      label,
          scoreBack:  scoreBack,
          scoreFront: scoreFront,
          penalty:    penalty
        };
      });

      backCams = scored
        .slice()
        .sort(function(a, b) { return (b.scoreBack - b.penalty) - (a.scoreBack - a.penalty); })
        .filter(function(x) { return x.scoreBack > 0 || (!x.label && x.deviceId); });

      frontCams = scored
        .slice()
        .sort(function(a, b) { return (b.scoreFront - b.penalty) - (a.scoreFront - a.penalty); })
        .filter(function(x) { return x.scoreFront > 0 || (!x.label && x.deviceId); });

      log('–ù–∞–π–¥–µ–Ω–æ –∫–∞–º–µ—Ä: –≤—Å–µ–≥–æ=' + vids.length +
          ' back=' + backCams.length +
          ' front=' + frontCams.length);

      backCams.slice(0, 5).forEach(function(c, i) {
        log('back[' + i + ']: ' + (c.label || '(no label)'));
      });
      frontCams.slice(0, 3).forEach(function(c, i) {
        log('front[' + i + ']: ' + (c.label || '(no label)'));
      });
    });
  }

  // =============================================
  // Constraints
  // =============================================
  function buildConstraints(opts) {
    var baseVideo = {
      width:       { ideal: 1920, min: 640 },
      height:      { ideal: 1080, min: 480 },
      frameRate:   { ideal: 30,   min: 15  },
      aspectRatio: { ideal: 16 / 9 },
      resizeMode:  { ideal: 'none' }
    };

    if (opts.useDeviceId && opts.deviceId) {
      baseVideo.deviceId = { exact: opts.deviceId };
      return { video: baseVideo, audio: false };
    }

    baseVideo.facingMode = { ideal: opts.facingMode };
    return { video: baseVideo, audio: false };
  }

  // =============================================
  // –ó–∞–ø—É—Å–∫ –∫–∞–º–µ—Ä—ã
  // =============================================
  function startCamera() {
    stopCamera();

    var facingMode = useFrontCamera ? 'user' : 'environment';
    setStatus('–ó–∞–ø—É—Å–∫ –∫–∞–º–µ—Ä—ã...');
    log('–ó–∞–ø—É—Å–∫: ' + facingMode);

    var stream = null;

    navigator.mediaDevices.getUserMedia(
      buildConstraints({ useDeviceId: false, facingMode: facingMode })
    )
    .then(function(s) {
      stream = s;
      log('–ö–∞–º–µ—Ä–∞ OK (–ø–µ—Ä–≤–∏—á–Ω—ã–π —Å—Ç–∞—Ä—Ç –ø–æ facingMode)');

      currentStream = stream;
      currentTrack  = stream.getVideoTracks()[0];
      video.srcObject = stream;

      return refreshDeviceLists().catch(function(e) {
        log('enumerateDevices –æ—à–∏–±–∫–∞: ' + e.message);
      });
    })
    .then(function() {
      // –í—ã–±–∏—Ä–∞–µ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –∫–∞–º–µ—Ä—É –ø–æ deviceId
      var chosen = null;

      if (!useFrontCamera) {
        chosen = backCams[backIndex] ? backCams[backIndex].deviceId : null;
        if (chosen) {
          log('–ü—Ä–æ–±—É—é –∑–∞–¥–Ω—é—é –ø–æ deviceId (index=' + backIndex + ')');
        }
      } else {
        chosen = frontCams[frontIndex] ? frontCams[frontIndex].deviceId : null;
        if (chosen) {
          log('–ü—Ä–æ–±—É—é —Ñ—Ä–æ–Ω—Ç –ø–æ deviceId (index=' + frontIndex + ')');
        }
      }

      if (!chosen) {
        log('deviceId –Ω–µ –Ω–∞–π–¥–µ–Ω ‚Äî –æ—Å—Ç–∞—é—Å—å –Ω–∞ facingMode');
        return Promise.resolve();
      }

      // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–µ—Ä–≤—ã–π –ø–æ—Ç–æ–∫ –∏ –æ—Ç–∫—Ä—ã–≤–∞–µ–º –ø–æ deviceId
      if (currentStream) {
        currentStream.getTracks().forEach(function(t) { t.stop(); });
      }

      return navigator.mediaDevices.getUserMedia(
        buildConstraints({ useDeviceId: true, deviceId: chosen, facingMode: facingMode })
      )
      .then(function(s2) {
        currentStream   = s2;
        currentTrack    = s2.getVideoTracks()[0];
        video.srcObject = s2;
        log('–û—Ç–∫—Ä—ã—Ç–∞ –∫–∞–º–µ—Ä–∞ –ø–æ deviceId ‚úÖ');
      })
      .catch(function(e) {
        log('deviceId —Å—Ç–∞—Ä—Ç fail: ' + e.name + ' / ' + e.message);
      });
    })
    .then(function() {
      // –õ–æ–≥ –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Ç—Ä–µ–∫–∞
      try {
        var s = currentTrack.getSettings();
        log('Track: ' + (s.width || '?') + 'x' + (s.height || '?') +
            ' facing=' + (s.facingMode || '?'));
      } catch (e) { /* ignore */ }

      return waitLoadedMetadata(video);
    })
    .then(function() {
      return tuneTrackAndRefocus();
    })
    .then(function() {
      flashOn = false;
      flashBtn.classList.remove('on');
      return video.play();
    })
    .then(function() {
      log('–í–∏–¥–µ–æ: ' + video.videoWidth + 'x' + video.videoHeight);
      setStatus('–ö–∞–º–µ—Ä–∞ –∞–∫—Ç–∏–≤–Ω–∞. –ò—â—É QR-–∫–æ–¥...');
      scanActive = true;
      requestScan();
    })
    .catch(function(e) {
      log('startCamera –æ—à–∏–±–∫–∞: ' + e.name + ' / ' + e.message);
      setStatus('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ', 'error');
    });
  }

  // =============================================
  // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ñ–æ–∫—É—Å–∞
  // =============================================
  function tuneTrackAndRefocus() {
    if (!currentTrack || !currentTrack.getCapabilities) {
      return Promise.resolve();
    }

    try {
      var caps = currentTrack.getCapabilities();
      log('Caps keys: ' + Object.keys(caps).join(', '));

      var chain = Promise.resolve();

      // 1) continuous focus
      if (caps.focusMode && caps.focusMode.indexOf('continuous') !== -1) {
        chain = chain.then(function() {
          return currentTrack.applyConstraints({
            advanced: [{ focusMode: 'continuous' }]
          });
        }).then(function() {
          log('‚Üí focusMode: continuous');
        });
      }

      // 2) single-shot refocus, –∑–∞—Ç–µ–º –æ–±—Ä–∞—Ç–Ω–æ continuous
      if (caps.focusMode && caps.focusMode.indexOf('single-shot') !== -1) {
        chain = chain.then(function() {
          return currentTrack.applyConstraints({
            advanced: [{ focusMode: 'single-shot' }]
          });
        }).then(function() {
          log('‚Üí focusMode: single-shot (refocus)');
          return new Promise(function(r) { setTimeout(r, 250); });
        }).then(function() {
          if (caps.focusMode && caps.focusMode.indexOf('continuous') !== -1) {
            return currentTrack.applyConstraints({
              advanced: [{ focusMode: 'continuous' }]
            }).then(function() {
              log('‚Üí focusMode: continuous (after refocus)');
            });
          }
        });
      }

      // 3) focusDistance
      if (caps.focusDistance &&
          caps.focusDistance.min != null &&
          caps.focusDistance.max != null &&
          caps.focusDistance.min !== caps.focusDistance.max) {
        chain = chain.then(function() {
          return currentTrack.applyConstraints({
            advanced: [{ focusDistance: caps.focusDistance.min }]
          });
        }).then(function() {
          log('‚Üí focusDistance: ' + caps.focusDistance.min + ' (near for QR)');
        });
      }

      return chain.then(function() {
        log('applyConstraints OK');
      }).catch(function(e) {
        log('tune/refocus –æ—à–∏–±–∫–∞: ' + e.message);
      });

    } catch (e) {
      log('tune/refocus –æ—à–∏–±–∫–∞: ' + e.message);
      return Promise.resolve();
    }
  }

  // =============================================
  // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–∞–º–µ—Ä—ã
  // =============================================
  function stopCamera() {
    scanActive = false;

    if (animFrameId) {
      cancelAnimationFrame(animFrameId);
      animFrameId = null;
    }

    if (currentStream) {
      currentStream.getTracks().forEach(function(t) { t.stop(); });
      currentStream = null;
      currentTrack  = null;
    }

    video.srcObject = null;
  }

  // =============================================
  // –í—Å–ø—ã—à–∫–∞
  // =============================================
  function toggleFlash() {
    if (!currentTrack) { return; }

    try {
      var caps = currentTrack.getCapabilities ? currentTrack.getCapabilities() : {};
      if (!caps.torch) {
        setStatus('–í—Å–ø—ã—à–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞', 'warning');
        setTimeout(function() {
          setStatus('–ö–∞–º–µ—Ä–∞ –∞–∫—Ç–∏–≤–Ω–∞. –ò—â—É QR-–∫–æ–¥...');
        }, 2000);
        return;
      }

      flashOn = !flashOn;
      currentTrack.applyConstraints({ advanced: [{ torch: flashOn }] })
        .then(function() {
          flashBtn.classList.toggle('on', flashOn);
          log('–í—Å–ø—ã—à–∫–∞: ' + (flashOn ? '–í–ö–õ' : '–í–´–ö–õ'));
        })
        .catch(function(e) {
          log('–í—Å–ø—ã—à–∫–∞ –æ—à–∏–±–∫–∞: ' + e.message);
        });
    } catch (e) {
      log('–í—Å–ø—ã—à–∫–∞ –æ—à–∏–±–∫–∞: ' + e.message);
    }
  }

  // =============================================
  // –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
  // =============================================
  function requestScan() {
    if (!scanActive) { return; }
    animFrameId = requestAnimationFrame(scanFrame);
  }

  function scanFrame() {
    if (!scanActive) { return; }
    if (!jsQRReady)  { requestScan(); return; }

    if (video.readyState !== video.HAVE_ENOUGH_DATA) {
      requestScan();
      return;
    }

    var w = video.videoWidth;
    var h = video.videoHeight;
    if (!w || !h) { requestScan(); return; }

    var cropW = Math.floor(w * SCAN_CENTER_FRACTION);
    var cropH = Math.floor(h * SCAN_CENTER_FRACTION);
    var cropX = Math.floor((w - cropW) / 2);
    var cropY = Math.floor((h - cropH) / 2);

    canvas.width  = cropW;
    canvas.height = cropH;
    ctx.drawImage(video, cropX, cropY, cropW, cropH, 0, 0, cropW, cropH);

    var imageData;
    try {
      imageData = ctx.getImageData(0, 0, cropW, cropH);
    } catch (e) {
      requestScan();
      return;
    }

    var code = jsQR(imageData.data, cropW, cropH, { inversionAttempts: 'attemptBoth' });
    if (code && code.data) {
      onQRDetected(code.data);
      return;
    }

    requestScan();
  }

  // =============================================
  // QR –Ω–∞–π–¥–µ–Ω
  // =============================================
  function onQRDetected(qrData) {
    scanActive = false;
    log('QR: ' + qrData);
    setStatus('‚úÖ QR-–∫–æ–¥ —Å—á–∏—Ç–∞–Ω!', 'success');

    try {
      if (navigator.vibrate) { navigator.vibrate(200); }
    } catch (e) { /* ignore */ }

    var payload = JSON.stringify({
      event_id: eventId,
      qr_Data:  qrData
    });

    log('Payload: ' + payload);

    if (isTelegram) {
      try {
        tg.sendData(payload);
        log('sendData() OK');
        setTimeout(function() {
          try { tg.close(); } catch (e) { /* ignore */ }
        }, 2000);
      } catch (e) {
        log('sendData –æ—à–∏–±–∫–∞: ' + e.message);
        setStatus('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏', 'error');
        resumeScanAfterDelay();
      }
    } else {
      setStatus('QR: ' + qrData, 'success');
      resumeScanAfterDelay();
    }
  }

  function resumeScanAfterDelay() {
    setTimeout(function() {
      scanActive = true;
      requestScan();
      setStatus('–ö–∞–º–µ—Ä–∞ –∞–∫—Ç–∏–≤–Ω–∞. –ò—â—É QR-–∫–æ–¥...');
    }, 3000);
  }

  // =============================================
  // –ö–Ω–æ–ø–∫–∏
  // =============================================
  switchBtn.addEventListener('click', function() {
    useFrontCamera = !useFrontCamera;
    log('–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ: ' + (useFrontCamera ? '—Ñ—Ä–æ–Ω—Ç' : '–∑–∞–¥–Ω—è—è'));
    startCamera();
  });

  lensBtn.addEventListener('click', function() {
    if (useFrontCamera) {
      if (frontCams.length <= 1) {
        setStatus('–ù–µ—Ç –¥—Ä—É–≥–∏—Ö —Ñ—Ä–æ–Ω—Ç –∫–∞–º–µ—Ä', 'warning');
        return;
      }
      frontIndex = (frontIndex + 1) % frontCams.length;
      log('–õ–∏–Ω–∑–∞ —Ñ—Ä–æ–Ω—Ç: index=' + frontIndex);
    } else {
      if (backCams.length <= 1) {
        setStatus('–ù–µ—Ç –¥—Ä—É–≥–∏—Ö –∑–∞–¥–Ω–∏—Ö –∫–∞–º–µ—Ä', 'warning');
        return;
      }
      backIndex = (backIndex + 1) % backCams.length;
      log('–õ–∏–Ω–∑–∞ –∑–∞–¥–Ω—è—è: index=' + backIndex);
    }
    startCamera();
  });

  flashBtn.addEventListener('click', function() {
    toggleFlash();
  });

  closeBtn.addEventListener('click', function() {
    stopCamera();
    if (isTelegram) {
      try { tg.close(); } catch (e) { /* ignore */ }
    }
    setStatus('–°–∫–∞–Ω–µ—Ä –∑–∞–∫—Ä—ã—Ç');
  });

  // =============================================
  // –ó–ê–ü–£–°–ö
  // =============================================
  loadJsQR()
    .then(function() {
      jsQRReady = true;
      log('jsQR –≥–æ—Ç–æ–≤');

      if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
        log('getUserMedia OK');
        startCamera();
      } else {
        setStatus('–ö–∞–º–µ—Ä–∞ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è', 'error');
        log('getUserMedia –ù–ï –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è');
        if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
          setStatus('–ù—É–∂–µ–Ω HTTPS! –ü—Ä–æ—Ç–æ–∫–æ–ª: ' + location.protocol, 'error');
        }
      }
    })
    .catch(function(e) {
      log('–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: ' + e.message);
      setStatus('–°–∫–∞–Ω–µ—Ä –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.', 'error');
    });
</script>

</body>
</html>
