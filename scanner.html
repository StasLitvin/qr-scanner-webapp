<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>QR Scanner</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a2e;
            color: #ffffff;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .header {
            padding: 16px;
            text-align: center;
            width: 100%;
            background: #16213e;
        }

        .header h1 {
            font-size: 18px;
            font-weight: 600;
        }

        .header p {
            font-size: 13px;
            color: #a0a0b0;
            margin-top: 4px;
        }

        .scanner-container {
            position: relative;
            width: 100%;
            max-width: 400px;
            margin: 12px auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0 12px;
        }

        .video-wrapper {
            position: relative;
            width: 100%;
            border-radius: 12px;
            overflow: hidden;
            border: 2px solid #0f3460;
            background: #000;
        }

        #video {
            width: 100%;
            display: block;
        }

        .scan-region {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 200px;
            height: 200px;
            pointer-events: none;
        }

        .scan-region .corner {
            position: absolute;
            width: 30px;
            height: 30px;
            border-color: #e94560;
            border-style: solid;
            border-width: 0;
        }

        .corner.tl { top: 0; left: 0; border-top-width: 4px; border-left-width: 4px; border-radius: 8px 0 0 0; }
        .corner.tr { top: 0; right: 0; border-top-width: 4px; border-right-width: 4px; border-radius: 0 8px 0 0; }
        .corner.bl { bottom: 0; left: 0; border-bottom-width: 4px; border-left-width: 4px; border-radius: 0 0 0 8px; }
        .corner.br { bottom: 0; right: 0; border-bottom-width: 4px; border-right-width: 4px; border-radius: 0 0 8px 0; }

        .scan-line {
            position: absolute;
            left: 10%;
            width: 80%;
            height: 2px;
            background: #e94560;
            animation: scanAnimation 2s linear infinite;
        }

        @keyframes scanAnimation {
            0% { top: 10%; }
            50% { top: 90%; }
            100% { top: 10%; }
        }

        #canvas {
            display: none;
        }

        .zoom-control {
            width: 100%;
            margin-top: 10px;
            padding: 10px 14px;
            background: #16213e;
            border-radius: 8px;
            display: none;
        }

        .zoom-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .zoom-label span {
            font-size: 13px;
            color: #a0a0b0;
        }

        .zoom-label .zoom-value {
            font-size: 14px;
            font-weight: 600;
            color: #e94560;
            min-width: 40px;
            text-align: right;
        }

        .zoom-slider-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .zoom-icon {
            font-size: 16px;
            color: #a0a0b0;
            flex-shrink: 0;
            user-select: none;
        }

        .zoom-slider-row input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #0d0d1a;
            outline: none;
        }

        .zoom-slider-row input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: #e94560;
            cursor: pointer;
            border: 2px solid #fff;
            box-shadow: 0 0 6px rgba(233, 69, 96, 0.5);
        }

        .zoom-slider-row input[type="range"]::-moz-range-thumb {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: #e94560;
            cursor: pointer;
            border: 2px solid #fff;
            box-shadow: 0 0 6px rgba(233, 69, 96, 0.5);
        }

        .zoom-presets {
            display: flex;
            gap: 6px;
            margin-top: 8px;
        }

        .zoom-preset-btn {
            flex: 1;
            padding: 6px 0;
            border: 1px solid #0f3460;
            border-radius: 6px;
            background: transparent;
            color: #a0a0b0;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .zoom-preset-btn.active {
            background: #e94560;
            border-color: #e94560;
            color: #fff;
        }

        .zoom-preset-btn:active {
            transform: scale(0.95);
        }

        .status {
            margin-top: 12px;
            padding: 12px 20px;
            background: #16213e;
            border-radius: 8px;
            font-size: 14px;
            text-align: center;
            width: 100%;
        }

        .status.success { background: #1b5e20; }
        .status.error { background: #b71c1c; }
        .status.warning { background: #e65100; }

        .btn-row {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            width: 100%;
        }

        .btn {
            flex: 1;
            padding: 12px 16px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            color: #fff;
            transition: background 0.2s;
        }

        .btn-switch { background: #0f3460; }
        .btn-switch:active { background: #1a5276; }
        .btn-flash { background: #533483; }
        .btn-flash:active { background: #6c44a2; }
        .btn-flash.on { background: #f0a500; color: #1a1a2e; }
        .btn-close { background: #b71c1c; }
        .btn-close:active { background: #d32f2f; }

        .debug {
            margin-top: 8px;
            padding: 8px 12px;
            background: #0d0d1a;
            border-radius: 6px;
            font-size: 11px;
            color: #666;
            width: 100%;
            max-height: 120px;
            overflow-y: auto;
            word-break: break-all;
        }
    </style>
</head>
<body>

<div class="header">
    <h1>–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ QR-–∫–æ–¥–∞</h1>
    <p>–ù–∞–≤–µ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ QR-–∫–æ–¥ —É—á–∞—Å—Ç–Ω–∏–∫–∞</p>
</div>

<div class="scanner-container">
    <div class="video-wrapper">
        <video id="video" autoplay playsinline muted></video>
        <div class="scan-region">
            <div class="corner tl"></div>
            <div class="corner tr"></div>
            <div class="corner bl"></div>
            <div class="corner br"></div>
            <div class="scan-line"></div>
        </div>
    </div>

    <canvas id="canvas"></canvas>

    <div class="zoom-control" id="zoomControl">
        <div class="zoom-label">
            <span>–ú–∞—Å—à—Ç–∞–± –∫–∞–º–µ—Ä—ã</span>
            <span class="zoom-value" id="zoomValue">1.0x</span>
        </div>
        <div class="zoom-slider-row">
            <span class="zoom-icon">‚àí</span>
            <input type="range" id="zoomSlider" min="1" max="10" step="0.1" value="1">
            <span class="zoom-icon">+</span>
        </div>
        <div class="zoom-presets" id="zoomPresets"></div>
    </div>

    <div class="status" id="status">–ó–∞–ø—É—Å–∫ –∫–∞–º–µ—Ä—ã...</div>

    <div class="btn-row">
        <button class="btn btn-switch" id="switchBtn">üì∑ –ö–∞–º–µ—Ä–∞</button>
        <button class="btn btn-flash" id="flashBtn">üî¶ –í—Å–ø—ã—à–∫–∞</button>
        <button class="btn btn-close" id="closeBtn">‚úï –ó–∞–∫—Ä—ã—Ç—å</button>
    </div>

    <div class="debug" id="debug">–õ–æ–≥: –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>

<script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d', { willReadFrequently: true });
    const statusEl = document.getElementById('status');
    const debugEl = document.getElementById('debug');
    const switchBtn = document.getElementById('switchBtn');
    const flashBtn = document.getElementById('flashBtn');
    const closeBtn = document.getElementById('closeBtn');
    const zoomControl = document.getElementById('zoomControl');
    const zoomSlider = document.getElementById('zoomSlider');
    const zoomValueEl = document.getElementById('zoomValue');
    const zoomPresetsEl = document.getElementById('zoomPresets');

    let currentStream = null;
    let currentTrack = null;
    let useFrontCamera = false;
    let flashOn = false;
    let scanActive = true;
    let animFrameId = null;
    let zoomCapabilities = null;
    let debugLines = [];

    const SCAN_CENTER_FRACTION = 0.6;

    const urlParams = new URLSearchParams(window.location.search);
    const eventId = urlParams.get('event_id') || '0';

    let tg = null;
    let isTelegram = false;
    try {
        if (window.Telegram && window.Telegram.WebApp) {
            tg = window.Telegram.WebApp;
            tg.expand();
            tg.ready();
            isTelegram = true;
            log('Telegram WebApp –æ–±–Ω–∞—Ä—É–∂–µ–Ω');
        } else {
            log('–ê–≤—Ç–æ–Ω–æ–º–Ω—ã–π —Ä–µ–∂–∏–º');
        }
    } catch (e) {
        log('TG –æ—à–∏–±–∫–∞: ' + e.message);
    }

    log('event_id = ' + eventId);

    function log(msg) {
        const time = new Date().toLocaleTimeString();
        const line = time + ' | ' + msg;
        debugLines.push(line);
        if (debugLines.length > 15) debugLines.shift();
        debugEl.textContent = debugLines.join('\n');
        debugEl.scrollTop = debugEl.scrollHeight;
        console.log('[QR]', msg);
    }

    function setStatus(text, cls) {
        statusEl.textContent = text;
        statusEl.className = 'status' + (cls ? ' ' + cls : '');
    }

    // ============================================================
    // –ö–ê–ú–ï–†–ê ‚Äî –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ constraints
    // ============================================================
    async function startCamera() {
        stopCamera();

        const facingMode = useFrontCamera ? 'user' : 'environment';
        log('–ó–∞–ø—É—Å–∫: ' + facingMode);
        setStatus('–ó–∞–ø—É—Å–∫ –∫–∞–º–µ—Ä—ã...');

        // ============================================================
        // –°—Ç—Ä–∞—Ç–µ–≥–∏—è: –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –í–´–°–û–ö–û–ï —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ —á–µ—Ä–µ–∑ ideal,
        // –ù–ï —á–µ—Ä–µ–∑ exact. –ö–∞–º–µ—Ä–∞ —Å–∞–º–∞ –≤—ã–±–µ—Ä–µ—Ç –±–ª–∏–∂–∞–π—à–µ–µ –Ω–∞—Ç–∏–≤–Ω–æ–µ.
        // –ö–ª—é—á: –ù–ï —É–∫–∞–∑—ã–≤–∞–µ–º width+height exact ‚Äî —Ç–æ–ª—å–∫–æ ideal.
        // ideal: 1920x1080 ‚Üí –∫–∞–º–µ—Ä–∞ –¥–∞—Å—Ç Full HD –µ—Å–ª–∏ –º–æ–∂–µ—Ç,
        // –∏–ª–∏ –±–ª–∏–∂–∞–π—à–µ–µ –º–µ–Ω—å—à–µ–µ –ë–ï–ó —Ü–∏—Ñ—Ä–æ–≤–æ–≥–æ –∫—Ä–æ–ø–∞.
        // ============================================================
        const constraintsList = [
            // –í–∞—Ä–∏–∞–Ω—Ç 1: –∑–∞–¥–Ω—è—è –∫–∞–º–µ—Ä–∞, –≤—ã—Å–æ–∫–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ
            {
                video: {
                    facingMode: { exact: facingMode },
                    width: { ideal: 1920, min: 640 },
                    height: { ideal: 1080, min: 480 }
                },
                audio: false
            },
            // –í–∞—Ä–∏–∞–Ω—Ç 2: –±–µ–∑ exact facingMode
            {
                video: {
                    facingMode: facingMode,
                    width: { ideal: 1920, min: 640 },
                    height: { ideal: 1080, min: 480 }
                },
                audio: false
            },
            // –í–∞—Ä–∏–∞–Ω—Ç 3: —Ç–æ–ª—å–∫–æ facingMode ideal
            {
                video: {
                    facingMode: { ideal: facingMode },
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                },
                audio: false
            },
            // –í–∞—Ä–∏–∞–Ω—Ç 4: –ª—é–±–∞—è –∫–∞–º–µ—Ä–∞ —Å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ–º
            {
                video: {
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                },
                audio: false
            },
            // –í–∞—Ä–∏–∞–Ω—Ç 5: —Å–æ–≤—Å–µ–º fallback
            {
                video: true,
                audio: false
            }
        ];

        let stream = null;
        for (let i = 0; i < constraintsList.length; i++) {
            try {
                stream = await navigator.mediaDevices.getUserMedia(constraintsList[i]);
                log('–ö–∞–º–µ—Ä–∞ OK (–≤–∞—Ä–∏–∞–Ω—Ç ' + (i + 1) + ')');
                break;
            } catch (err) {
                log('–í–∞—Ä–∏–∞–Ω—Ç ' + (i + 1) + ' fail: ' + err.name);
            }
        }

        if (!stream) {
            setStatus('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ', 'error');
            log('–í—Å–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –ø—Ä–æ–≤–∞–ª–∏–ª–∏—Å—å');
            return;
        }

        currentStream = stream;
        currentTrack = stream.getVideoTracks()[0];
        video.srcObject = stream;

        // –õ–æ–≥–∏—Ä—É–µ–º —á—Ç–æ –ø–æ–ª—É—á–∏–ª–∏
        const settings = currentTrack.getSettings();
        log('Track settings: ' + settings.width + 'x' + settings.height +
            ' facing=' + (settings.facingMode || '?'));

        // ============================================================
        // –ü–û–°–õ–ï –ø–æ–ª—É—á–µ–Ω–∏—è —Ç—Ä–µ–∫–∞ ‚Äî –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Ñ–æ–∫—É—Å –∏ –∑—É–º
        // —á–µ—Ä–µ–∑ applyConstraints (–Ω–µ —á–µ—Ä–µ–∑ getUserMedia!)
        // ============================================================
        await tuneTrack();
        await setupZoom();

        flashOn = false;
        flashBtn.classList.remove('on');

        video.onloadedmetadata = () => {
            video.play().then(() => {
                log('–í–∏–¥–µ–æ: ' + video.videoWidth + 'x' + video.videoHeight);
                setStatus('–ö–∞–º–µ—Ä–∞ –∞–∫—Ç–∏–≤–Ω–∞. –ò—â—É QR-–∫–æ–¥...');
                scanActive = true;
                requestScan();
            }).catch(err => {
                log('play() –æ—à–∏–±–∫–∞: ' + err.message);
                setStatus('–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è', 'error');
            });
        };

        video.onerror = () => {
            log('–û—à–∏–±–∫–∞ –≤–∏–¥–µ–æ');
            setStatus('–û—à–∏–±–∫–∞ –≤–∏–¥–µ–æ', 'error');
        };
    }

    // ============================================================
    // –¢–æ–Ω–∫–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç—Ä–µ–∫–∞: –∞–≤—Ç–æ—Ñ–æ–∫—É—Å + —Å–±—Ä–æ—Å –∑—É–º–∞
    // ============================================================
    async function tuneTrack() {
        if (!currentTrack) return;

        try {
            const caps = currentTrack.getCapabilities();
            const advanced = [];

            // –õ–æ–≥–∏—Ä—É–µ–º –≤—Å–µ capabilities –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
            log('Caps keys: ' + Object.keys(caps).join(', '));

            // --- –ê–≤—Ç–æ—Ñ–æ–∫—É—Å ---
            if (caps.focusMode) {
                log('focusModes: ' + caps.focusMode.join(', '));
                if (caps.focusMode.includes('continuous')) {
                    advanced.push({ focusMode: 'continuous' });
                    log('‚Üí focusMode: continuous');
                } else if (caps.focusMode.includes('auto')) {
                    advanced.push({ focusMode: 'auto' });
                    log('‚Üí focusMode: auto');
                }
            } else {
                log('focusMode –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è');
            }

            // --- –°–±—Ä–æ—Å –∑—É–º–∞ –Ω–∞ –º–∏–Ω–∏–º—É–º ---
            if (caps.zoom) {
                advanced.push({ zoom: caps.zoom.min });
                log('‚Üí zoom —Å–±—Ä–æ—à–µ–Ω –Ω–∞ ' + caps.zoom.min);
            }

            // --- –ü—Ä–∏–º–µ–Ω—è–µ–º ---
            if (advanced.length > 0) {
                await currentTrack.applyConstraints({ advanced: advanced });
                log('applyConstraints OK');
            }
        } catch (e) {
            log('tuneTrack –æ—à–∏–±–∫–∞: ' + e.message);
        }
    }

    function stopCamera() {
        scanActive = false;
        if (animFrameId) {
            cancelAnimationFrame(animFrameId);
            animFrameId = null;
        }
        if (currentStream) {
            currentStream.getTracks().forEach(t => t.stop());
            currentStream = null;
            currentTrack = null;
        }
        video.srcObject = null;
        zoomControl.style.display = 'none';
        zoomCapabilities = null;
    }

    // ====== ZOOM UI ======
    async function setupZoom() {
        if (!currentTrack) return;
        try {
            const caps = currentTrack.getCapabilities();
            if (caps.zoom) {
                zoomCapabilities = caps.zoom;
                const minZ = zoomCapabilities.min;
                const maxZ = zoomCapabilities.max;
                const stepZ = zoomCapabilities.step || 0.1;

                log('Zoom UI: ' + minZ + ' - ' + maxZ);

                zoomSlider.min = minZ;
                zoomSlider.max = maxZ;
                zoomSlider.step = stepZ;
                zoomSlider.value = minZ;
                zoomValueEl.textContent = minZ.toFixed(1) + 'x';

                createZoomPresets(minZ, maxZ);
                zoomControl.style.display = 'block';
            } else {
                zoomControl.style.display = 'none';
            }
        } catch (e) {
            zoomControl.style.display = 'none';
        }
    }

    async function applyZoom(value) {
        if (!currentTrack) return;
        try {
            await currentTrack.applyConstraints({ advanced: [{ zoom: value }] });
        } catch (e) {
            log('zoom –æ—à–∏–±–∫–∞: ' + e.message);
        }
    }

    function createZoomPresets(minZ, maxZ) {
        zoomPresetsEl.innerHTML = '';
        const presets = [];
        presets.push({ label: minZ.toFixed(1) + 'x', value: minZ });

        const range = maxZ - minZ;
        if (range > 0.5) presets.push({ label: (minZ + range * 0.25).toFixed(1) + 'x', value: minZ + range * 0.25 });
        if (range > 1) presets.push({ label: (minZ + range * 0.5).toFixed(1) + 'x', value: minZ + range * 0.5 });
        if (range > 2) presets.push({ label: (minZ + range * 0.75).toFixed(1) + 'x', value: minZ + range * 0.75 });
        presets.push({ label: maxZ.toFixed(1) + 'x', value: maxZ });

        const unique = [];
        const seen = new Set();
        for (const p of presets) {
            const key = p.value.toFixed(1);
            if (!seen.has(key)) { seen.add(key); unique.push(p); }
        }

        unique.forEach((preset, idx) => {
            const btn = document.createElement('button');
            btn.className = 'zoom-preset-btn' + (idx === 0 ? ' active' : '');
            btn.textContent = preset.label;
            btn.addEventListener('click', async () => {
                zoomSlider.value = preset.value;
                zoomValueEl.textContent = preset.value.toFixed(1) + 'x';
                await applyZoom(preset.value);
                updatePresetActive(preset.value);
            });
            zoomPresetsEl.appendChild(btn);
        });
    }

    function updatePresetActive(val) {
        zoomPresetsEl.querySelectorAll('.zoom-preset-btn').forEach(btn => {
            const v = parseFloat(btn.textContent);
            btn.classList.toggle('active', Math.abs(v - val) < 0.05);
        });
    }

    zoomSlider.addEventListener('input', async () => {
        const val = parseFloat(zoomSlider.value);
        zoomValueEl.textContent = val.toFixed(1) + 'x';
        await applyZoom(val);
        updatePresetActive(val);
    });

    // ====== –í–°–ü–´–®–ö–ê ======
    async function toggleFlash() {
        if (!currentTrack) return;
        try {
            const caps = currentTrack.getCapabilities();
            if (!caps.torch) {
                setStatus('–í—Å–ø—ã—à–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞', 'warning');
                setTimeout(() => setStatus('–ö–∞–º–µ—Ä–∞ –∞–∫—Ç–∏–≤–Ω–∞. –ò—â—É QR-–∫–æ–¥...'), 2000);
                return;
            }
            flashOn = !flashOn;
            await currentTrack.applyConstraints({ advanced: [{ torch: flashOn }] });
            flashBtn.classList.toggle('on', flashOn);
            log('–í—Å–ø—ã—à–∫–∞: ' + (flashOn ? '–í–ö–õ' : '–í–´–ö–õ'));
        } catch (e) {
            log('–í—Å–ø—ã—à–∫–∞ –æ—à–∏–±–∫–∞: ' + e.message);
        }
    }

    // ====== –°–ö–ê–ù–ò–†–û–í–ê–ù–ò–ï ======
    function requestScan() {
        if (!scanActive) return;
        animFrameId = requestAnimationFrame(scanFrame);
    }

    function scanFrame() {
        if (!scanActive) return;
        if (video.readyState !== video.HAVE_ENOUGH_DATA) { requestScan(); return; }

        const w = video.videoWidth;
        const h = video.videoHeight;
        if (w === 0 || h === 0) { requestScan(); return; }

        // –°–∫–∞–Ω–∏—Ä—É–µ–º —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–µ 60% –∫–∞–¥—Ä–∞
        const cropW = Math.floor(w * SCAN_CENTER_FRACTION);
        const cropH = Math.floor(h * SCAN_CENTER_FRACTION);
        const cropX = Math.floor((w - cropW) / 2);
        const cropY = Math.floor((h - cropH) / 2);

        canvas.width = cropW;
        canvas.height = cropH;
        ctx.drawImage(video, cropX, cropY, cropW, cropH, 0, 0, cropW, cropH);

        let imageData;
        try {
            imageData = ctx.getImageData(0, 0, cropW, cropH);
        } catch (e) {
            requestScan();
            return;
        }

        const code = jsQR(imageData.data, cropW, cropH, {
            inversionAttempts: 'attemptBoth'
        });

        if (code && code.data) {
            onQRDetected(code.data);
            return;
        }

        requestScan();
    }

    // ====== QR –ù–ê–ô–î–ï–ù ======
    function onQRDetected(qrData) {
        scanActive = false;
        log('QR: ' + qrData);
        setStatus('‚úÖ QR-–∫–æ–¥ —Å—á–∏—Ç–∞–Ω!', 'success');

        try { if (navigator.vibrate) navigator.vibrate(200); } catch (e) {}

        const payload = JSON.stringify({
            event_id: eventId,
            qr_Data: qrData
        });

        log('Payload: ' + payload);

        if (isTelegram) {
            try {
                tg.sendData(payload);
                log('sendData() OK');
                setTimeout(() => { try { tg.close(); } catch(e) {} }, 2000);
            } catch (e) {
                log('sendData –æ—à–∏–±–∫–∞: ' + e.message);
                setStatus('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏', 'error');
                resumeScanAfterDelay();
            }
        } else {
            setStatus('QR: ' + qrData, 'success');
            resumeScanAfterDelay();
        }
    }

    function resumeScanAfterDelay() {
        setTimeout(() => {
            scanActive = true;
            requestScan();
            setStatus('–ö–∞–º–µ—Ä–∞ –∞–∫—Ç–∏–≤–Ω–∞. –ò—â—É QR-–∫–æ–¥...');
        }, 3000);
    }

    // ====== –ö–ù–û–ü–ö–ò ======
    switchBtn.addEventListener('click', () => {
        useFrontCamera = !useFrontCamera;
        log('–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ: ' + (useFrontCamera ? '—Ñ—Ä–æ–Ω—Ç' : '–∑–∞–¥–Ω—è—è'));
        startCamera();
    });

    flashBtn.addEventListener('click', () => toggleFlash());

    closeBtn.addEventListener('click', () => {
        stopCamera();
        if (isTelegram) { try { tg.close(); } catch(e) {} }
        setStatus('–°–∫–∞–Ω–µ—Ä –∑–∞–∫—Ä—ã—Ç');
    });

    // ====== –ó–ê–ü–£–°–ö ======
    if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
        log('getUserMedia OK');
        startCamera();
    } else {
        setStatus('–ö–∞–º–µ—Ä–∞ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è', 'error');
        log('getUserMedia –ù–ï –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è');
        if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
            setStatus('–ù—É–∂–µ–Ω HTTPS! –ü—Ä–æ—Ç–æ–∫–æ–ª: ' + location.protocol, 'error');
        }
    }
</script>

</body>
</html>
